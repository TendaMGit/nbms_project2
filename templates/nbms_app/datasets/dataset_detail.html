{% extends "nbms_app/base.html" %}
{% block title %}Dataset{% endblock %}
{% block content %}
  <h1>{{ dataset.title }}</h1>
  <div class="card">
    <p><strong>Status:</strong> {{ dataset.status }}</p>
    <p><strong>Sensitivity:</strong> {{ dataset.sensitivity }}</p>
    <p><strong>Description:</strong> {{ dataset.description|default:"-" }}</p>
    <p><strong>Methodology:</strong> {{ dataset.methodology|default:"-" }}</p>
    <p><strong>Source URL:</strong> {% if dataset.source_url %}<a href="{{ dataset.source_url }}">{{ dataset.source_url }}</a>{% else %}-{% endif %}</p>
    {% if can_edit %}
      <p><a href="{% url 'nbms_app:dataset_edit' dataset.uuid %}">Edit dataset</a></p>
    {% endif %}
  </div>
  <section class="card readiness-card readiness-{{ readiness.status }}">
    <header class="card-header">
      <div class="card-title">
        <span aria-hidden="true">ðŸ§¾</span>
        <h2>Compliance Panel</h2>
      </div>
      <span class="badge badge-{{ readiness.status }}">{{ readiness.status|title }}</span>
    </header>
    <div class="card-body">
      <p><strong>Release readiness:</strong> {{ readiness.status|title }}</p>
      <h3>Metadata checks</h3>
      {% for check in readiness.checks %}
        {% if check.key != "approval" and check.key != "consent" %}
          <div class="check-row">
            <span class="check-icon">
              {% if check.state == "ok" %}âœ”{% elif check.state == "missing" %}â›”{% else %}âš {% endif %}
            </span>
            <span class="check-label">{{ check.label }}</span>
          </div>
        {% endif %}
      {% endfor %}
      {% if readiness.details.linked_indicator_count %}
        <p><strong>Used by indicators:</strong> {{ readiness.details.linked_indicator_count }}</p>
        {% if readiness.details.linked_indicator_codes %}
          <p class="muted">Examples: {{ readiness.details.linked_indicator_codes|join:", " }}</p>
        {% endif %}
      {% endif %}
      {% if current_instance %}
        <p><strong>Approved indicators (current instance):</strong> {{ readiness.details.approved_linked_indicator_count }}</p>
      {% endif %}
      {% if dataset.review_note %}
        <p><strong>Review note:</strong> {{ dataset.review_note }}</p>
      {% endif %}
      <h3>Instance readiness</h3>
      {% if current_instance %}
        <p><strong>Current instance:</strong> {{ current_instance }}</p>
        <div class="check-row">
          <span class="check-icon">{% if readiness.details.approval_status == "approved" %}âœ”{% else %}â›”{% endif %}</span>
          <span class="check-label">Approval: {{ readiness.details.approval_status|default:"not approved"|title }}</span>
        </div>
        <div class="check-row">
          <span class="check-icon">
            {% if readiness.details.consent_required %}
              {% if readiness.details.consent_status == "granted" %}âœ”{% else %}â›”{% endif %}
            {% else %}
              â—‹
            {% endif %}
          </span>
          <span class="check-label">Consent: {{ readiness.details.consent_status|default:"n/a"|title }}</span>
        </div>
        <div class="check-row">
          <span class="check-icon">{% if readiness.details.eligible_for_export %}âœ”{% else %}â›”{% endif %}</span>
          <span class="check-label">Eligible for export: {% if readiness.details.eligible_for_export %}Yes{% else %}No{% endif %}</span>
        </div>
        {% if approvals_url %}<p><a href="{{ approvals_url }}">Go to instance approvals</a></p>{% endif %}
        {% if consent_url %}<p><a href="{{ consent_url }}">Go to consent workspace</a></p>{% endif %}
      {% else %}
        <p class="muted">Set a current reporting instance to see export readiness.</p>
      {% endif %}
    </div>
  </section>
  <div class="card">
    <h2>Releases</h2>
    <ul>
      {% for release in releases %}
        <li>{{ release.version }} ({{ release.status }})</li>
      {% empty %}
        <li>No releases yet.</li>
      {% endfor %}
    </ul>
  </div>
  <p><a href="{% url 'nbms_app:dataset_list' %}">Back to list</a></p>
{% endblock %}
