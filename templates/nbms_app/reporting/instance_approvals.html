{% extends "nbms_app/base.html" %}
{% block title %}Instance Approvals{% endblock %}
{% block content %}
  <h1>Approvals: {{ instance.cycle.code }} {{ instance.version_label }}</h1>
  <p class="muted">Only published items should be approved for export.</p>
  {% if instance.frozen_at %}
    <div class="card">
      <p>This instance is frozen. Approvals require admin override.</p>
    </div>
  {% endif %}

  <div class="card">
    <nav class="actions">
      <a href="#indicators">Indicators</a>
      <a href="#targets">National Targets</a>
      <a href="#evidence">Evidence</a>
      <a href="#datasets">Datasets</a>
    </nav>
  </div>

  <div class="card" id="indicators">
    <h2>Indicators</h2>
    <div class="card">
      <form id="bulk-indicators-selected" method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="indicators" />
        <input type="hidden" name="mode" value="selected" />
        <label><input type="checkbox" id="select-all-indicators" /> Select all visible</label>
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve selected</button>
        <button type="submit" name="action" value="revoke">Revoke selected</button>
      </form>
      <form method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="indicators" />
        <input type="hidden" name="mode" value="visible" />
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve all visible</button>
        <button type="submit" name="action" value="revoke">Revoke all visible</button>
      </form>
      <form method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="indicators" />
        <input type="hidden" name="mode" value="rule" />
        <input type="hidden" name="rule_type" value="indicator_by_target" />
        <label>
          Target UUID:
          <input type="text" name="target_uuid" placeholder="Target UUID" />
        </label>
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve published indicators linked to target</button>
      </form>
    </div>
    <table>
      <thead>
        <tr>
          <th>Select</th>
          <th>Code</th>
          <th>Title</th>
          <th>Status</th>
          <th>Sensitivity</th>
          <th>Organisation</th>
          <th>Decision</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for item in indicator_items %}
          <tr>
            <td><input type="checkbox" name="selected" value="{{ item.obj.uuid }}" form="bulk-indicators-selected" data-group="indicators" /></td>
            <td>{{ item.obj.code }}</td>
            <td>{{ item.obj.title }}</td>
            <td>{{ item.obj.status }}</td>
            <td>{{ item.obj.sensitivity }}</td>
            <td>{{ item.obj.organisation|default:"-" }}</td>
            <td>{{ item.decision|default:"-" }}</td>
            <td>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'indicator' item.obj.uuid 'approve' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Approve</button>
              </form>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'indicator' item.obj.uuid 'revoke' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Revoke</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">No indicators available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card" id="targets">
    <h2>National Targets</h2>
    <div class="card">
      <form id="bulk-targets-selected" method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="targets" />
        <input type="hidden" name="mode" value="selected" />
        <label><input type="checkbox" id="select-all-targets" /> Select all visible</label>
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve selected</button>
        <button type="submit" name="action" value="revoke">Revoke selected</button>
      </form>
      <form method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="targets" />
        <input type="hidden" name="mode" value="visible" />
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve all visible</button>
        <button type="submit" name="action" value="revoke">Revoke all visible</button>
      </form>
    </div>
    <table>
      <thead>
        <tr>
          <th>Select</th>
          <th>Code</th>
          <th>Title</th>
          <th>Status</th>
          <th>Sensitivity</th>
          <th>Organisation</th>
          <th>Decision</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for item in target_items %}
          <tr>
            <td><input type="checkbox" name="selected" value="{{ item.obj.uuid }}" form="bulk-targets-selected" data-group="targets" /></td>
            <td>{{ item.obj.code }}</td>
            <td>{{ item.obj.title }}</td>
            <td>{{ item.obj.status }}</td>
            <td>{{ item.obj.sensitivity }}</td>
            <td>{{ item.obj.organisation|default:"-" }}</td>
            <td>{{ item.decision|default:"-" }}</td>
            <td>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'target' item.obj.uuid 'approve' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Approve</button>
              </form>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'target' item.obj.uuid 'revoke' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Revoke</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">No national targets available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card" id="evidence">
    <h2>Evidence</h2>
    <div class="card">
      <form id="bulk-evidence-selected" method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="evidence" />
        <input type="hidden" name="mode" value="selected" />
        <label><input type="checkbox" id="select-all-evidence" /> Select all visible</label>
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve selected</button>
        <button type="submit" name="action" value="revoke">Revoke selected</button>
      </form>
      <form method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="evidence" />
        <input type="hidden" name="mode" value="visible" />
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve all visible</button>
        <button type="submit" name="action" value="revoke">Revoke all visible</button>
      </form>
    </div>
    <table>
      <thead>
        <tr>
          <th>Select</th>
          <th>Title</th>
          <th>Status</th>
          <th>Sensitivity</th>
          <th>Organisation</th>
          <th>Decision</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for item in evidence_items %}
          <tr>
            <td><input type="checkbox" name="selected" value="{{ item.obj.uuid }}" form="bulk-evidence-selected" data-group="evidence" /></td>
            <td>{{ item.obj.title }}</td>
            <td>{{ item.obj.status }}</td>
            <td>{{ item.obj.sensitivity }}</td>
            <td>{{ item.obj.organisation|default:"-" }}</td>
            <td>{{ item.decision|default:"-" }}</td>
            <td>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'evidence' item.obj.uuid 'approve' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Approve</button>
              </form>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'evidence' item.obj.uuid 'revoke' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Revoke</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7">No evidence available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card" id="datasets">
    <h2>Datasets</h2>
    <div class="card">
      <form id="bulk-datasets-selected" method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="datasets" />
        <input type="hidden" name="mode" value="selected" />
        <label><input type="checkbox" id="select-all-datasets" /> Select all visible</label>
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve selected</button>
        <button type="submit" name="action" value="revoke">Revoke selected</button>
      </form>
      <form method="post" action="{% url 'nbms_app:reporting_instance_approval_bulk' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="obj_type" value="datasets" />
        <input type="hidden" name="mode" value="visible" />
        {% if instance.frozen_at and is_admin %}
          <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
        {% endif %}
        <button type="submit" name="action" value="approve">Approve all visible</button>
        <button type="submit" name="action" value="revoke">Revoke all visible</button>
      </form>
    </div>
    <table>
      <thead>
        <tr>
          <th>Select</th>
          <th>Title</th>
          <th>Status</th>
          <th>Sensitivity</th>
          <th>Organisation</th>
          <th>Decision</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for item in dataset_items %}
          <tr>
            <td><input type="checkbox" name="selected" value="{{ item.obj.uuid }}" form="bulk-datasets-selected" data-group="datasets" /></td>
            <td>{{ item.obj.title }}</td>
            <td>{{ item.obj.status }}</td>
            <td>{{ item.obj.sensitivity }}</td>
            <td>{{ item.obj.organisation|default:"-" }}</td>
            <td>{{ item.decision|default:"-" }}</td>
            <td>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'dataset' item.obj.uuid 'approve' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Approve</button>
              </form>
              <form method="post" action="{% url 'nbms_app:reporting_instance_approval_action' instance.uuid 'dataset' item.obj.uuid 'revoke' %}">
                {% csrf_token %}
                <input type="text" name="note" placeholder="Note" />
                {% if instance.frozen_at and is_admin %}
                  <label><input type="checkbox" name="admin_override" value="1" /> Admin override</label>
                {% endif %}
                <button type="submit">Revoke</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7">No datasets available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p><a href="{% url 'nbms_app:reporting_instance_detail' instance.uuid %}">Back to instance</a></p>
  <script>
    const bulkConfig = [
      ["select-all-indicators", "indicators"],
      ["select-all-targets", "targets"],
      ["select-all-evidence", "evidence"],
      ["select-all-datasets", "datasets"],
    ];
    bulkConfig.forEach(([toggleId, group]) => {
      const toggle = document.getElementById(toggleId);
      if (!toggle) {
        return;
      }
      toggle.addEventListener("change", (event) => {
        document.querySelectorAll(`input[data-group="${group}"]`).forEach((checkbox) => {
          checkbox.checked = event.target.checked;
        });
      });
    });
  </script>
{% endblock %}
