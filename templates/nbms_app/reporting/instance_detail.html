{% extends "nbms_app/base.html" %}
{% block title %}Reporting Instance{% endblock %}
{% block content %}
  <h1>{{ instance.cycle.code }} {{ instance.version_label }}</h1>
  <div class="card">
    <p><strong>Status:</strong> {{ instance.status }}</p>
    <p><strong>Notes:</strong> {{ instance.notes|default:"-" }}</p>
    <p><strong>Frozen at:</strong> {{ instance.frozen_at|default:"-" }}</p>
    <p><strong>Frozen by:</strong> {{ instance.frozen_by|default:"-" }}</p>
  </div>
  <div class="card">
    <h2>Instance Readiness</h2>
    <p><strong>Release readiness:</strong> {{ readiness.status|title }}</p>
    {% if readiness.blockers or readiness.warnings %}
      <details>
        <summary>Why?</summary>
        {% if readiness.blockers %}
          <p><strong>Blockers</strong></p>
          <ul>
            {% for item in readiness.blockers %}
              <li>{{ item.message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if readiness.warnings %}
          <p><strong>Warnings</strong></p>
          <ul>
            {% for item in readiness.warnings %}
              <li>{{ item.message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </details>
    {% endif %}

    <h3>Sections</h3>
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Title</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for section in readiness.details.sections.sections %}
          <tr>
            <td>{{ section.code }}</td>
            <td>{{ section.title }}</td>
            <td>
              {% if section.state == "completed" %}Completed{% endif %}
              {% if section.state == "draft" %}Draft{% endif %}
              {% if section.state == "missing" %}Missing{% endif %}
            </td>
            <td>
              <a href="{{ section.edit_url }}">Edit</a> |
              <a href="{{ section.preview_url }}">Preview</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No sections configured.</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% if readiness.details.sections.missing_required_sections %}
      <p><strong>Missing required sections:</strong> {{ readiness.details.sections.missing_required_sections|join:", " }}</p>
      {% if readiness.details.export_require_sections %}
        <p><strong>Export would be blocked</strong> because required sections are missing.</p>
      {% endif %}
    {% endif %}
    {% if readiness.details.sections.incomplete_required_sections %}
      <p><strong>Incomplete required sections:</strong> {{ readiness.details.sections.incomplete_required_sections|join:", " }}</p>
    {% endif %}
    <p><a href="{% url 'nbms_app:reporting_instance_sections' instance.uuid %}">Open sections list</a></p>

    <h3>Approvals</h3>
    <ul>
      <li>
        Indicators:
        <a href="{{ approvals_links.indicators }}">{{ readiness.details.approvals.indicators.approved }}/{{ readiness.details.approvals.indicators.total }}</a>
      </li>
      <li>
        Targets:
        <a href="{{ approvals_links.targets }}">{{ readiness.details.approvals.targets.approved }}/{{ readiness.details.approvals.targets.total }}</a>
      </li>
      <li>
        Evidence:
        <a href="{{ approvals_links.evidence }}">{{ readiness.details.approvals.evidence.approved }}/{{ readiness.details.approvals.evidence.total }}</a>
      </li>
      <li>
        Datasets:
        <a href="{{ approvals_links.datasets }}">{{ readiness.details.approvals.datasets.approved }}/{{ readiness.details.approvals.datasets.total }}</a>
      </li>
    </ul>
    <p><a href="{{ approvals_url }}">Open approval workspace</a></p>

    <h3>Consent</h3>
    <p>Missing consent for approved IPLC records: {{ readiness.counts.missing_consents }}</p>
    {% if readiness.counts.missing_consents %}
      <p><strong>Export would be blocked</strong> until consent is granted.</p>
    {% endif %}
    <p><a href="{{ consent_url }}">Open consent workspace</a></p>

    <h3>Freeze</h3>
    <p><strong>Frozen:</strong> {% if instance.frozen_at %}Yes{% else %}No{% endif %}</p>
    {% if instance.frozen_at %}
      <p>This instance is frozen. Most edits and approvals are locked unless an admin override is used.</p>
    {% endif %}
  </div>
  <div class="card">
    {% if instance.frozen_at %}
      <p>This instance is frozen. Approvals are locked unless an admin override is used.</p>
      {% if is_admin %}
        <form method="post" action="{% url 'nbms_app:reporting_instance_freeze' instance.uuid %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="unfreeze" />
          <button type="submit">Unfreeze instance</button>
        </form>
      {% endif %}
  {% else %}
      <form method="post" action="{% url 'nbms_app:reporting_instance_freeze' instance.uuid %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="freeze" />
        <button type="submit">Freeze instance</button>
      </form>
    {% endif %}
  </div>
  <p><a href="{% url 'nbms_app:reporting_instance_sections' instance.uuid %}">Report sections</a></p>
  <p><a href="{% url 'nbms_app:reporting_instance_approvals' instance.uuid %}">Approval workspace</a></p>
  <p><a href="{% url 'nbms_app:reporting_instance_consent' instance.uuid %}">Consent workspace</a></p>
  <p><a href="{% url 'nbms_app:reporting_cycle_detail' instance.cycle.uuid %}">Back to cycle</a></p>
{% endblock %}
