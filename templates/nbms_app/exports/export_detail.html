{% extends "nbms_app/base.html" %}
{% block title %}Export Package{% endblock %}
{% block content %}
  <h1>{{ package.title }}</h1>
  <div class="card">
    <p><strong>Status:</strong> {{ package.status }}</p>
    <p><strong>Reporting instance:</strong> {{ package.reporting_instance|default:"-" }}</p>
    <p><strong>Description:</strong> {{ package.description|default:"-" }}</p>
    <p><strong>Review note:</strong> {{ package.review_note|default:"-" }}</p>
  </div>
  <section class="card readiness-card readiness-{{ readiness.status }}">
    <header class="card-header">
      <div class="card-title">
        <span aria-hidden="true">ðŸ“¦</span>
        <h2>Package Eligibility</h2>
      </div>
      <span class="badge badge-{{ readiness.status }}">{{ readiness.status|title }}</span>
    </header>
    <div class="card-body">
      <p><strong>Release readiness:</strong> {{ readiness.status|title }}</p>
      {% if readiness.blockers or readiness.warnings %}
        <details>
          <summary>Why?</summary>
          {% if readiness.blockers %}
            <p><strong>Blockers</strong></p>
            <ul>
              {% for item in readiness.blockers %}
                <li>{{ item.message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
          {% if readiness.warnings %}
            <p><strong>Warnings</strong></p>
            <ul>
              {% for item in readiness.warnings %}
                <li>{{ item.message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </details>
      {% endif %}
      <h3>Requirements</h3>
      {% for check in readiness.checks %}
        <div class="check-row">
          <span class="check-icon">
            {% if check.state == "ok" %}âœ”{% elif check.state == "missing" or check.state == "blocked" %}â›”{% elif check.state == "incomplete" %}âš {% else %}â—‹{% endif %}
          </span>
          <span class="check-label">{{ check.label }}</span>
          {% if check.action_url %}
            <span class="check-actions"><a href="{{ check.action_url }}">Fix</a></span>
          {% endif %}
        </div>
      {% endfor %}
      <h3>Included counts</h3>
      <div class="check-row">
        <span class="check-icon">âœ”</span>
        <span class="check-label">Indicators: {{ readiness.counts.approved_indicators }}</span>
      </div>
      <div class="check-row">
        <span class="check-icon">âœ”</span>
        <span class="check-label">Targets: {{ readiness.counts.approved_targets }}</span>
      </div>
      <div class="check-row">
        <span class="check-icon">âœ”</span>
        <span class="check-label">Evidence: {{ readiness.counts.approved_evidence }}</span>
      </div>
      <div class="check-row">
        <span class="check-icon">âœ”</span>
        <span class="check-label">Datasets: {{ readiness.counts.approved_datasets }}</span>
      </div>
    </div>
  </section>

  <div class="card">
    {% if can_submit and package.status == "draft" %}
      <form method="post" action="{% url 'nbms_app:export_package_action' package.uuid 'submit' %}">
        {% csrf_token %}
        <button type="submit">Submit for review</button>
      </form>
    {% endif %}

    {% if can_review and package.status == "pending_review" %}
      <form method="post" action="{% url 'nbms_app:export_package_action' package.uuid 'approve' %}">
        {% csrf_token %}
        <label>
          Note:
          <input type="text" name="note" />
        </label>
        <button type="submit">Approve</button>
      </form>
      <form method="post" action="{% url 'nbms_app:export_package_action' package.uuid 'reject' %}">
        {% csrf_token %}
        <label>
          Note:
          <input type="text" name="note" />
        </label>
        <button type="submit">Reject</button>
      </form>
    {% endif %}

    {% if can_release and package.status == "approved" %}
      <form method="post" action="{% url 'nbms_app:export_package_action' package.uuid 'release' %}">
        {% csrf_token %}
        <button type="submit">Release</button>
      </form>
    {% endif %}

    {% if package.status == "released" %}
      <p><a href="{% url 'nbms_app:export_package_download' package.uuid %}">Download export</a></p>
    {% endif %}
  </div>

  <p><a href="{% url 'nbms_app:export_package_list' %}">Back to list</a></p>
{% endblock %}
