# Generated by Django 5.2.9 on 2026-02-07 07:32

import django.contrib.postgres.indexes
import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models
from django.utils.text import slugify
from nbms_app import spatial_fields


def _backfill_spatial_registry(apps, schema_editor):
    SpatialLayer = apps.get_model("nbms_app", "SpatialLayer")
    SpatialFeature = apps.get_model("nbms_app", "SpatialFeature")
    Dataset = apps.get_model("nbms_app", "Dataset")
    Evidence = apps.get_model("nbms_app", "Evidence")
    IndicatorDataSeries = apps.get_model("nbms_app", "IndicatorDataSeries")

    for layer in SpatialLayer.objects.all().order_by("id"):
        if not layer.title:
            layer.title = layer.name
        if not layer.layer_code:
            seed = layer.slug or layer.name or f"layer-{layer.id}"
            layer.layer_code = slugify(seed).replace("-", "_").upper()
        layer.save(update_fields=["title", "layer_code", "updated_at"])

    for feature in SpatialFeature.objects.all().order_by("id"):
        changed = False
        if not feature.feature_id:
            feature.feature_id = feature.feature_key or f"feature-{feature.id}"
            changed = True
        if not feature.properties and feature.properties_json:
            feature.properties = feature.properties_json
            changed = True
        if changed:
            feature.save(update_fields=["feature_id", "properties", "updated_at"])

    for row in Dataset.objects.filter(dataset_code__isnull=True).order_by("id"):
        row.dataset_code = f"DS-{row.id:06d}"
        row.save(update_fields=["dataset_code", "updated_at"])

    for row in Evidence.objects.filter(evidence_code__isnull=True).order_by("id"):
        row.evidence_code = f"EV-{row.id:06d}"
        row.save(update_fields=["evidence_code", "updated_at"])

    for row in IndicatorDataSeries.objects.filter(series_code__isnull=True).order_by("id"):
        if row.indicator_id:
            row.series_code = f"SER-I-{row.indicator_id}"
        elif row.framework_indicator_id:
            row.series_code = f"SER-F-{row.framework_indicator_id}"
        else:
            row.series_code = f"SER-{row.id:06d}"
        row.save(update_fields=["series_code", "updated_at"])


def _noop_reverse(apps, schema_editor):
    return


class Migration(migrations.Migration):

    dependencies = [
        ('nbms_app', '0034_birdiesite_birdiespecies_integrationdataasset_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='SpatialUnit',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('uuid', models.UUIDField(default=uuid.uuid4, editable=False, unique=True)),
                ('unit_code', models.CharField(max_length=80, unique=True)),
                ('name', models.CharField(max_length=255)),
                ('geom', spatial_fields.MultiPolygonField(blank=True, null=True, srid=4326)),
                ('bbox', spatial_fields.PolygonField(blank=True, null=True, srid=4326)),
                ('area_km2', models.DecimalField(blank=True, decimal_places=6, max_digits=20, null=True)),
                ('centroid', spatial_fields.PointField(blank=True, null=True, srid=4326)),
                ('properties', models.JSONField(blank=True, default=dict)),
                ('sensitivity', models.CharField(choices=[('public', 'Public'), ('internal', 'Internal'), ('restricted', 'Restricted'), ('iplc_sensitive', 'IPLC-sensitive')], default='public', max_length=20)),
                ('consent_required', models.BooleanField(default=False)),
                ('is_active', models.BooleanField(default=True)),
            ],
            options={
                'ordering': ['unit_type__code', 'unit_code'],
            },
        ),
        migrations.CreateModel(
            name='SpatialUnitType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('code', models.CharField(max_length=50, unique=True)),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True)),
                ('default_geom_type', models.CharField(choices=[('point', 'Point'), ('line', 'Line'), ('polygon', 'Polygon'), ('geometry', 'Geometry')], default='polygon', max_length=20)),
                ('admin_level', models.PositiveIntegerField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
            ],
            options={
                'ordering': ['code'],
            },
        ),
        migrations.AddField(
            model_name='dataset',
            name='dataset_code',
            field=models.CharField(blank=True, max_length=80, null=True, unique=True),
        ),
        migrations.AddField(
            model_name='evidence',
            name='evidence_code',
            field=models.CharField(blank=True, max_length=80, null=True, unique=True),
        ),
        migrations.AddField(
            model_name='indicatordatapoint',
            name='spatial_layer',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='indicator_data_points', to='nbms_app.spatiallayer'),
        ),
        migrations.AddField(
            model_name='indicatordatapoint',
            name='spatial_resolution',
            field=models.CharField(blank=True, max_length=120),
        ),
        migrations.AddField(
            model_name='indicatordataseries',
            name='series_code',
            field=models.CharField(blank=True, max_length=100, null=True, unique=True),
        ),
        migrations.AddField(
            model_name='indicatordataseries',
            name='spatial_layer',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='indicator_data_series', to='nbms_app.spatiallayer'),
        ),
        migrations.AddField(
            model_name='indicatordataseries',
            name='spatial_resolution',
            field=models.CharField(blank=True, max_length=120),
        ),
        migrations.AddField(
            model_name='spatialfeature',
            name='feature_id',
            field=models.CharField(blank=True, max_length=160),
        ),
        migrations.AddField(
            model_name='spatialfeature',
            name='geom',
            field=spatial_fields.GeometryField(blank=True, null=True, srid=4326),
        ),
        migrations.AddField(
            model_name='spatialfeature',
            name='properties',
            field=models.JSONField(blank=True, default=dict),
        ),
        migrations.AddField(
            model_name='spatialfeature',
            name='valid_from',
            field=models.DateField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='spatialfeature',
            name='valid_to',
            field=models.DateField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='attribution',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='consent_required',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='data_ref',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='export_approved',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='layer_code',
            field=models.CharField(blank=True, max_length=100, null=True, unique=True),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='license',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='source_file',
            field=models.FileField(blank=True, null=True, upload_to='spatial/uploads/'),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='source_file_hash',
            field=models.CharField(blank=True, max_length=64),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='temporal_extent',
            field=models.JSONField(blank=True, default=dict),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='theme',
            field=models.CharField(blank=True, max_length=60),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='title',
            field=models.CharField(blank=True, max_length=255),
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='update_frequency',
            field=models.CharField(blank=True, choices=[('annual', 'Annual'), ('quarterly', 'Quarterly'), ('monthly', 'Monthly'), ('ad_hoc', 'Ad hoc'), ('continuous', 'Continuous')], max_length=20),
        ),
        migrations.AlterField(
            model_name='spatiallayer',
            name='source_type',
            field=models.CharField(choices=[('NBMS_TABLE', 'NBMS table'), ('UPLOADED_FILE', 'Uploaded file'), ('EXTERNAL_WMS', 'External WMS'), ('EXTERNAL_WFS', 'External WFS'), ('EXTERNAL_STAC', 'External STAC'), ('EXTERNAL_TILE', 'External tile'), ('static', 'Static (legacy)'), ('indicator', 'Indicator (legacy)')], default='NBMS_TABLE', max_length=30),
        ),
        migrations.CreateModel(
            name='SpatialIngestionRun',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('uuid', models.UUIDField(default=uuid.uuid4, editable=False, unique=True)),
                ('run_id', models.CharField(max_length=80, unique=True)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('running', 'Running'), ('succeeded', 'Succeeded'), ('failed', 'Failed')], default='pending', max_length=20)),
                ('source_filename', models.CharField(blank=True, max_length=255)),
                ('source_format', models.CharField(blank=True, max_length=50)),
                ('source_hash', models.CharField(blank=True, max_length=64)),
                ('source_storage_path', models.CharField(blank=True, max_length=512)),
                ('source_layer_name', models.CharField(blank=True, max_length=255)),
                ('rows_ingested', models.PositiveIntegerField(default=0)),
                ('invalid_geom_before_fix', models.PositiveIntegerField(default=0)),
                ('invalid_geom_after_fix', models.PositiveIntegerField(default=0)),
                ('report_json', models.JSONField(blank=True, default=dict)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('finished_at', models.DateTimeField(blank=True, null=True)),
                ('layer', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='ingestion_runs', to='nbms_app.spatiallayer')),
                ('triggered_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='spatial_ingestion_runs', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.AddField(
            model_name='spatiallayer',
            name='latest_ingestion_run',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='latest_for_layers', to='nbms_app.spatialingestionrun'),
        ),
        migrations.RunPython(_backfill_spatial_registry, _noop_reverse),
        migrations.AddIndex(
            model_name='spatiallayer',
            index=models.Index(fields=['layer_code'], name='nbms_app_sp_layer_c_91ca01_idx'),
        ),
        migrations.AddIndex(
            model_name='spatiallayer',
            index=models.Index(fields=['theme'], name='nbms_app_sp_theme_29892d_idx'),
        ),
        migrations.AddField(
            model_name='spatialunit',
            name='organisation',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='spatial_units', to='nbms_app.organisation'),
        ),
        migrations.AddField(
            model_name='spatialunit',
            name='parent',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='children', to='nbms_app.spatialunit'),
        ),
        migrations.AddField(
            model_name='indicatordatapoint',
            name='spatial_unit',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='indicator_data_points', to='nbms_app.spatialunit'),
        ),
        migrations.AddField(
            model_name='monitoringprogramme',
            name='coverage_units',
            field=models.ManyToManyField(blank=True, related_name='coverage_programmes', to='nbms_app.spatialunit'),
        ),
        migrations.AddField(
            model_name='spatialfeature',
            name='spatial_unit',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='spatial_features', to='nbms_app.spatialunit'),
        ),
        migrations.AddIndex(
            model_name='indicatordatapoint',
            index=models.Index(fields=['series', 'year'], name='nbms_app_in_series__4bd568_idx'),
        ),
        migrations.AddIndex(
            model_name='indicatordatapoint',
            index=models.Index(fields=['spatial_unit'], name='nbms_app_in_spatial_e854e3_idx'),
        ),
        migrations.AddIndex(
            model_name='indicatordatapoint',
            index=models.Index(fields=['spatial_layer'], name='nbms_app_in_spatial_e38f09_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialfeature',
            index=models.Index(fields=['layer', 'feature_id'], name='nbms_app_sp_layer_i_a722aa_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialfeature',
            index=models.Index(fields=['spatial_unit'], name='nbms_app_sp_spatial_d1b52d_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialfeature',
            index=django.contrib.postgres.indexes.GinIndex(fields=['properties'], name='nbms_spatial_feature_props_gin'),
        ),
        migrations.AddIndex(
            model_name='spatialfeature',
            index=spatial_fields.GistIndex(fields=['geom'], name='nbms_spatial_feature_geom_gix'),
        ),
        migrations.AddConstraint(
            model_name='spatialfeature',
            constraint=models.UniqueConstraint(condition=models.Q(('feature_id', ''), _negated=True), fields=('layer', 'feature_id'), name='uq_spatial_feature_layer_id'),
        ),
        migrations.AddField(
            model_name='spatialunit',
            name='unit_type',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='units', to='nbms_app.spatialunittype'),
        ),
        migrations.AddField(
            model_name='indicatordataseries',
            name='spatial_unit_type',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='indicator_data_series', to='nbms_app.spatialunittype'),
        ),
        migrations.AddIndex(
            model_name='indicatordataseries',
            index=models.Index(fields=['series_code'], name='nbms_app_in_series__01b1bd_idx'),
        ),
        migrations.AddIndex(
            model_name='indicatordataseries',
            index=models.Index(fields=['spatial_unit_type'], name='nbms_app_in_spatial_923244_idx'),
        ),
        migrations.AddIndex(
            model_name='indicatordataseries',
            index=models.Index(fields=['spatial_layer'], name='nbms_app_in_spatial_ddb30d_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialingestionrun',
            index=models.Index(fields=['layer', 'created_at'], name='nbms_app_sp_layer_i_e701aa_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialingestionrun',
            index=models.Index(fields=['status', 'created_at'], name='nbms_app_sp_status_cbcd4b_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialunit',
            index=models.Index(fields=['unit_code'], name='nbms_app_sp_unit_co_fd65bf_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialunit',
            index=models.Index(fields=['unit_type', 'is_active'], name='nbms_app_sp_unit_ty_f59a96_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialunit',
            index=models.Index(fields=['sensitivity'], name='nbms_app_sp_sensiti_b1ceed_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialunit',
            index=models.Index(fields=['organisation'], name='nbms_app_sp_organis_15fd4b_idx'),
        ),
        migrations.AddIndex(
            model_name='spatialunit',
            index=spatial_fields.GistIndex(fields=['geom'], name='nbms_spatial_unit_geom_gix'),
        ),
    ]



